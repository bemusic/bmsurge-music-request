<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Be-Music Surge Request List</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <style>
      .song-requester {
        display: inline-block;
        height: 0px;
        width: 0px;
        margin-right: 2px;
      }
    </style>
<!--     <link rel="stylesheet" href="https://unpkg.com/bootstrap-vue@2.0.0-rc.28/dist/bootstrap-vue.min.css"> -->
  </head>
  <body>
    <div id="app">
      <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
        <a class="navbar-brand" href="https://be-music.surge.sh/">&larr; Be-Music Surge</a>
      </nav>
      <main role="main" class="container-fluid">
        <h1>
          Song Request
        </h1>
        <p>
          You can request a song to be played on <a href="https://be-music.surge.sh/">Be-Music Surge</a> radio station via Discord!
        </p>
        <ul>
          <li>
            Join the <a target="_blank" href="https://discord.gg/mjRUEnX">BMS Community</a> (or <a target="_blank" href="https://discord.gg/F6vg7JN">Bemuse</a>) Discord server.
          </li>
          <li>
            Send a <strong>direct message</strong> to <strong>Be-Music Surge#0450</strong> with your song request.
          </li>
          <li>
            The Discord bot will search for a song based on your message and adds it to the play queue.
            If many songs are found, it will choose one at random.
          </li>
          <li>
            Songs with more number of requests are played first.
          </li>
          <li>
            There is a limit on how many songs you can have on the play queue.
          </li>
          <li>
            Be-Music Surge will not pick a song thatâ€™s been played in the previous hour.
          </li>
        </ul>
        <h2>
          Song Request List
        </h2>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Genre</th>
              <th>Artist</th>
              <th>Title</th>
              <th>Event</th>
              <th colspan="2">Requesters</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="req in requests" :key="req.key">
              <td>{{ req.info.genre }}</td>
              <td>{{ req.info.artist }}</td>
              <td>{{ req.info.title }}</td>
              <td>{{ req.info.event }}</td>
              <td>
                <span v-for="r in req.requesters" class="song-requester" :style="requesterStyle(r.requesterId)"></span>
                <!-- small> {{ formatDate(req.firstRequested) }}</small -->
              </td>
              <td align="right">
                {{ req.requesters.length }}
              </td>
            </tr>
          </tbody>
        </table>
        <h2>
          Request a specific song
        </h2>
        <div style="min-height: 30em">
          <p>
            In addition to requesting a song from the Discord bot,
            you can also request a song from this web page.
            This will allow you to be specific on which song you want.
          </p>
          <div v-if="auth.checking">
            <p>
              Checking authentication state...
            </p>
          </div>
          <template v-else-if="!auth.user">
            <p>
              First, you need to log in. Send "<code>!login</code>" (without quotes) as a <strong>direct message</strong> to <strong>Be-Music Surge#0450</strong> to get a login token, and paste it here.
            </p>
            <form @submit="login($event, $event.target.token.value)">
              <div class="input-group">
                <input type="text" name="token" class="form-control" placeholder="Paste login token here"  :disabled="auth.loggingIn">
                <div class="input-group-append">
                  <button class="btn btn-primary" :disabled="auth.loggingIn">Log in</button>
                </div>
              </div>
            </form>
          </template>
          <template v-else>
            <p>
              Coming soon
            </p>
          </template>
        </div>
      </main>
    </div>

    <script src="https://unpkg.com/vue@2.6.10/dist/vue.js"></script>
<!--     <script src="https://unpkg.com/bootstrap-vue@2.0.0-rc.28/dist/bootstrap-vue.min.js"></script> -->

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.5.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.5.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.5.0/firebase-auth.js"></script>

    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyDUSQ9NYxkipb_s6Alze9lmFXSRxXKsXDY",
        authDomain: "be-music-surge-frontend.firebaseapp.com",
        databaseURL: "https://be-music-surge-frontend.firebaseio.com",
        projectId: "be-music-surge-frontend",
        storageBucket: "",
        messagingSenderId: "284392105315",
        appId: "1:284392105315:web:933567d122f91ecd0bdf56"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
    </script>

    <script>
      appInstance = new Vue({
        el: '#app',
        data: {
          requests: [],
          auth: {
            checking: true,
            user: null,
            loggingIn: false
          }
        },
        mounted() {
          firebase.database().ref('requests').on('value', (s) => {
            window.s = s
            const requests = []
            s.forEach(child => {
              const requesterKeys = Object.keys(child.child('requesters').val() || {})
              const requesters = requesterKeys.map(k => ({
                requesterId: k,
                requestedAt: child.child('requesters').child(k).val()
              }))
              requests.push({
                key: child.key,
                info: child.child('info').val(),
                requesters: requesters,
              })
            })
            if (location.search === '?test') {
              const items = [].concat(...requests.map(r => r.requesters)).sort((a, b) => a.requestedAt - b.requestedAt)
              const timeMap = new Map()
              items.forEach((item) => {
                const recorded = timeMap.get(item.requesterId)
                const T = 1200e3
                if (recorded != null && item.requestedAt < recorded + T) {
                  item.requestedAt = recorded + T
                }
                timeMap.set(item.requesterId, item.requestedAt)
              })
              console.log(JSON.stringify(items, null, 2))
            }
            const firstRequested = r => Math.min(...r.requesters.map(rr => rr.requestedAt)) || 0
            this.requests = requests
              .sort((a, b) => {
                return firstRequested(a) - firstRequested(b)
              })
              .sort((a, b) => {
                return b.requesters.length - a.requesters.length
              })
          })
          firebase.auth().onAuthStateChanged((user) => {
            this.auth.checking = false
            this.auth.user = user
          })
        },
        computed: {
          
        },
        methods: {
          formatDate(d) {
            return new Date(d).toISOString()
          },
          requesterStyle(r) {
            const a = `hsl(${parseInt(r.substr(0, 4), 16) % 360},90%,60%)`
            const b = `hsl(${parseInt(r.substr(4, 4), 16) % 360},90%,40%)`
            return {
              border: '6px solid transparent',
              borderColor: `${a} ${b} ${b} ${a}`
            }
          },
          async login(e, token) {
            e.preventDefault()
            this.auth.loggingIn = true
            try {
              await firebase.auth().signInWithCustomToken(token)
            } catch (e) {
              alert(`Cannot sign in: ${e}`)
            } finally {
              this.auth.loggingIn = false
            }
          }
        }
      })
    </script>
  </body>
</html>

